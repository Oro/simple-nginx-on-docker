box: golang
dev:
  steps:
    - setup-go-workspace:
        package-dir: ./

    - internal/watch:
        code: |
          go build -o app ./...
          ./app
        reload: true

build:
  steps:
    - setup-go-workspace:
        package-dir: ./

    - golint

    - script:
        name: go build
        code: |
          CGO_ENABLED=0 go build -a -ldflags '-s' -installsuffix cgo -o app ./...

    - script:
        name: go test
        code: |
          go test ./...

    - script:
        name: copy to output dir
        code: |
          cp -r source/static app $WERCKER_OUTPUT_DIR

deploy-dockerhub:
  steps:
    - internal/docker-scratch-push:
        username: $USERNAME
        password: $PASSWORD
        tag: latest, $WERCKER_GIT_COMMIT, $WERCKER_GIT_BRANCH
        cmd: ./app
        ports: 8080
        repository: oronu/nginx-simple-html
        registry: https://registry.hub.docker.com

kube-deploy:
  steps:
    - create-file:
      name: Create ca.pem
      cwd: deployment
      filename: ca.pem
      content: $CA_PEM

    - create-file:
      name: Create admin.pem
      cwd: deployment
      filename: admin.pem
      content: $ADMIN_PEM

    - create-file:
      name: Create admin-key.pem
      cwd: deployment
      filename: admin-key.pem
      content: $ADMIN_KEY_PEM        

    - kubectl:
      cwd: deployment
      server: $KUBERNETES_MASTER
      certificate-authority: ca.pem
      client-certificate: admin.pem
      client-key: admin-key.pem
      command: apply -f kube.yml

    - script:
      name: cleanup
      cwd: deployment
      code: rm -rf ca.pem admin.pem admin-key.pem kube.yml
